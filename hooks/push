#!/bin/sh
set -xe

# enable experimental cli to use manifest command
export DOCKER_CLI_EXPERIMENTAL=enabled

# include all architectures we build for
ARCHITECTURES="$(cat ./build.arch)"

amend(){
  for arch in $ARCHITECTURES
  do
    echo --amend "$IMAGE_NAME"-"$arch"
  done
  echo
}


for arch in $ARCHITECTURES
do
  docker push "$IMAGE_NAME-$arch"
done

docker manifest create "$IMAGE_NAME" $(amend | tr "\n" " ")
docker manifest push "$IMAGE_NAME"

